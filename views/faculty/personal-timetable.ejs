<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Personal Timetable</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
body{background:#eee}
.available-slot{
  background:#d5f4e6 !important;
  border:2px dashed #27ae60;
  cursor:pointer;
}
.schedule-btn{
  background:#3498db;
  color:white;
  font-size:12px;
  padding:3px 8px;
  border-radius:6px;
  margin-top:6px;
}
.schedule-btn:hover{background:#1f6fb2}
.scheduled-badge{
  background:#27ae60;
  color:white;
  font-size:11px;
  padding:2px 6px;
  border-radius:12px;
  display:inline-block;
  margin-top:4px;
}
#roomList {
  max-height: 400px;
  overflow-y: auto;
  padding-right: 8px;
}
#roomList::-webkit-scrollbar {
  width: 8px;
}
#roomList::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 10px;
}
#roomList::-webkit-scrollbar-thumb {
  background: #3498db;
  border-radius: 10px;
}
#roomList::-webkit-scrollbar-thumb:hover {
  background: #2980b9;
}
</style>
</head>

<body>

<header class="bg-[#0F044C] shadow-md py-4 px-6 w-full">
    <div class="flex items-center justify-between max-w-7xl mx-auto">
      <div class="flex items-center space-x-3">
        <img src="/images/Logo.png" alt="Logo" class="h-10 md:h-14 filter brightness-0 invert" />
      </div>

      <div class="hidden md:flex items-center space-x-4">
        <span class="text-white text-sm">Faculty: <%= teacherName %></span>
        <a href="/faculty" class="bg-[#0F044C] text-white px-4 py-2 rounded hover:bg-[#787A91] transition text-sm">Dashboard</a>
        <a href="/faculty/timetable" class="bg-[#0F044C] text-white px-4 py-2 rounded hover:bg-[#787A91] transition text-sm">Personal Timetable</a>
        <a href="/faculty/timetable/today" class="bg-[#0F044C] text-white px-4 py-2 rounded hover:bg-[#787A91] transition text-sm font-bold">Today's Classes</a>
        <a href="/faculty/full-timetable" class="bg-[#0F044C] text-white px-4 py-2 rounded hover:bg-[#787A91] transition text-sm">Full Timetable</a>
        <a href="/auth/logout" class="bg-[#0F044C] text-white px-4 py-2 rounded hover:bg-[#787A91] transition text-sm">Logout</a>
      </div>

      <div class="md:hidden relative">
        <button id="menuToggle" class="text-white focus:outline-none">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" stroke-width="2"
               viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
        </button>

        <div id="mobileMenu" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg hidden z-50">
          <a href="/faculty" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Dashboard</a>
          <a href="/faculty/timetable" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Personal Timetable</a>
          <a href="/faculty/timetable/today" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 font-bold">Today's Classes</a>
          <a href="/faculty/full-timetable" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Full Timetable</a>
          <a href="/auth/logout" class="block px-4 py-2 text-gray-800 hover:bg-gray-100">Logout</a>
        </div>
      </div>
    </div>
  </header>

<div class="p-8">

<table border="1" class="w-full text-center bg-white">
<thead class="bg-[#141E61] text-white">
<tr>
<th>Day</th>
<% slots.forEach(s=>{ %><th><%= s %></th><% }) %>
</tr>
</thead>

<tbody>

<%
days.forEach(day=>{
%>
<tr>
<th class="bg-gray-100"><%= day %></th>

<%
for(let i=0;i<slots.length;i++){
  let cls=null, course=null;
  let isScheduled = false;
  let scheduledInfo = null;
  let isNewSlotForSchedule = false;

  // Check if this slot has a scheduled class
  for(let c in personalTimetable){
    if(personalTimetable[c][day]?.[i]){
      cls=personalTimetable[c][day][i];
      course=c;
      
      // Check if this class is scheduled somewhere else
      const schedKey = `${day}-${i}`;
      if(scheduledClasses && scheduledClasses[schedKey]) {
        isScheduled = true;
        scheduledInfo = scheduledClasses[schedKey];
      }
      break;
    }
  }

  // Check if this is a NEW slot for any scheduled class
  for(let schedKey in scheduledClasses) {
    const sch = scheduledClasses[schedKey];
    if(sch.newSlot.day === day && sch.newSlot.slot === i) {
      isNewSlotForSchedule = true;
      scheduledInfo = sch;
    }
  }

  if(!cls && !isNewSlotForSchedule){
%>
<td>-</td>
<%
  }else if(isScheduled && scheduledInfo){
%>
<!-- SCHEDULED CLASS - ORIGINAL SLOT HIDDEN -->
<td style="background:#f0f0f0; opacity:0.6; border:2px dashed #999; cursor:not-allowed;">
  <span style="color:#999; font-size:12px;">[Rescheduled]</span>
</td>
<%
  }else if(isNewSlotForSchedule && scheduledInfo){
%>
<!-- NEW SLOT - SHOWS SCHEDULED CLASS WITH CLOCK ICON -->
<td style="background:#e8f5e9; border:3px solid #4caf50; cursor:pointer; position:relative;" 
    onclick="showScheduleDetails('<%= scheduledInfo.id %>')"
    title="<%= scheduledInfo.course %> - Scheduled from <%= scheduledInfo.originalSlot.day %> Slot <%= scheduledInfo.originalSlot.slot %>">

  <div style="font-size:24px;">ğŸ•’</div>
  <div style="font-weight:bold; font-size:12px; color:#1b5e20;"><%= scheduledInfo.course %></div>
  <div style="font-size:11px; color:#2e7d32;">Scheduled</div>
  <div style="font-size:10px; color:#555; margin-top:2px;">
    ğŸ“… <%= new Date(scheduledInfo.date).toLocaleDateString('en-GB') %>
  </div>
  <div style="font-size:10px; color:#555;">
    ğŸ›ï¸ <%= scheduledInfo.room %> (<%= scheduledInfo.building %>)
  </div>
</td>
<%
  }else if(cls){
%>
<td data-course="<%= course %>"
    data-day="<%= day %>"
    data-slot="<%= i %>"
    style="background:<%= cls.isLab?'#CBDCEB':'#d4e6f1' %>">

<b><%= course %></b><br>
<%= cls.subject %><br>
ğŸ› <%= cls.room %>

<% if(cls.scheduled){ %>
<div class="scheduled-badge">ğŸ•’ Scheduled</div>
<% }else{ %>
<button class="schedule-btn"
 onclick="startSchedule('<%= course %>','<%= day %>',<%= i %>, <%= cls.isLab ? 'true' : 'false' %>)">
ğŸ•’ Schedule
</button>
<% } %>

</td>
<%
  }
}
%>

</tr>
<% }) %>

</tbody>
</table>

</div>

<!-- ğŸ“Œ SCHEDULED CLASSES SECTION FOR TEACHER -->
<div class="mt-8 bg-white p-6 rounded shadow-lg">
  <h2 class="text-2xl font-bold text-[#0F044C] mb-4">ğŸ“Œ Rescheduled Classes</h2>
  
  <% if(Object.keys(scheduledClasses).length === 0) { %>
    <p class="text-gray-600">No rescheduled classes yet.</p>
  <% } else { %>
    <div class="space-y-4">
      <% Object.values(scheduledClasses).forEach(sch => { %>
        <div class="border-l-4 border-blue-500 bg-blue-50 p-4 rounded">
          <div class="flex justify-between items-start">
            <div>
              <h3 class="font-bold text-lg text-[#0F044C]"><%= sch.course %></h3>
              <p class="text-sm text-gray-700 mt-1">
                <strong>From:</strong> <%= sch.originalSlot.day %>, Slot <%= sch.originalSlot.slot %>
              </p>
              <p class="text-sm text-gray-700">
                <strong>To:</strong> <%= sch.newSlot.day %>, Slot <%= sch.newSlot.slot %> | 
                ğŸ“… <%= new Date(sch.date).toLocaleDateString('en-GB') %>
              </p>
              <p class="text-sm text-gray-700">
                <strong>Room:</strong> ğŸ›ï¸ <%= sch.room %> (<%= sch.building %>)
              </p>
            </div>
            <div class="text-right flex flex-col gap-2">
              <span class="inline-block bg-green-500 text-white px-3 py-1 rounded-full text-sm font-semibold">ğŸ•’ Scheduled</span>
              <button onclick="rescheduleClass('<%= sch.id %>')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                âœï¸ Reschedule
              </button>
              <button onclick="undoSchedule('<%= sch.id %>')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                â†©ï¸ Undo
              </button>
            </div>
          </div>
        </div>
      <% }); %>
    </div>
  <% } %>
</div>

<!-- DATE MODAL -->
<div id="dateModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">
<div class="bg-white p-6 rounded w-96">
<h3 class="font-bold mb-3">ğŸ—“ï¸ Select Date for <%= () => active.targetDay || 'day' %></h3>
<p class="text-sm text-gray-600 mb-4">ğŸ“Œ Only showing <%= () => active.targetDay %>'s dates</p>

<div id="dateList" class="space-y-2 max-h-64 overflow-y-auto border p-3 rounded bg-gray-50"></div>

<div class="mt-4 text-center">
  <button onclick="document.getElementById('dateModal').classList.add('hidden')" class="bg-gray-400 text-white px-4 py-2 rounded">
    Cancel
  </button>
</div>
</div>
</div>

<!-- ROOM MODAL -->
<div id="roomModal" class="hidden fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center">
<div class="bg-white p-6 rounded w-80">
<h3 class="font-bold mb-3">Select Room</h3>
<div id="roomList"></div>
</div>
</div>

<script>
const personalTimetable = <%- JSON.stringify(personalTimetable) %>;
const courseTimetables = <%- JSON.stringify(courseTimetables) %>;

let active={};

function startSchedule(course, day, slot, isLab) {
  // Get the subject from personalTimetable
  const subject = personalTimetable[course]?.[day]?.[slot]?.subject || '';
  active = { course, day, slot, subject, isLab: isLab === 'true' || isLab === true };
  highlightCourseLibrarySlots(course);
}

function rescheduleClass(scheduleId) {
  // Get the schedule details from scheduledClasses
  let schedule = null;
  for(let key in scheduledClasses) {
    if(scheduledClasses[key].id === scheduleId) {
      schedule = scheduledClasses[key];
      break;
    }
  }

  if(!schedule) {
    alert('âŒ Schedule not found');
    return;
  }

  // Set active for scheduling
  active = {
    course: schedule.course,
    day: schedule.originalSlot.day,
    slot: schedule.originalSlot.slot,
    subject: schedule.subject || '',
    isLab: schedule.isLab,
    rescheduleId: scheduleId // Track that we're rescheduling
  };

  // Start the scheduling process - highlight library slots
  highlightCourseLibrarySlots(schedule.course);
}

function undoSchedule(scheduleId) {
  if(!confirm('â“ Are you sure? This will move the class back to its original slot.')) {
    return;
  }

  fetch(`/schedule/api/undo-schedule/${scheduleId}`, {
    method: 'DELETE',
    headers: {'Content-Type': 'application/json'}
  })
  .then(r => r.json())
  .then(d => {
    if(d.success) {
      alert('âœ… ' + d.message);
      location.reload();
    } else {
      alert('âŒ Error: ' + (d.error || 'Failed to undo'));
    }
  })
  .catch(err => {
    console.error('âŒ Fetch error:', err);
    alert('âŒ Network error: ' + err.message);
  });
}

function showScheduleDetails(scheduleId) {
  // Find the scheduled class
  let found = null;
  for(let key in scheduledClasses) {
    if(scheduledClasses[key].id === scheduleId) {
      found = scheduledClasses[key];
      break;
    }
  }
  
  if(!found) {
    alert('Schedule not found');
    return;
  }

  const message = `ğŸ“Œ Class Scheduled Details\n\n` +
    `Course: ${found.course}\n` +
    `From: ${found.originalSlot.day} - Slot ${found.originalSlot.slot}\n` +
    `To: ${found.newSlot.day} - Slot ${found.newSlot.slot}\n` +
    `Date: ${new Date(found.date).toLocaleDateString('en-GB')}\n` +
    `Room: ${found.room} (${found.building})`;
  
  alert(message);
}

function highlightCourseLibrarySlots(course) {

  // clear old highlights
  document.querySelectorAll('.available-slot').forEach(td => {
    td.classList.remove('available-slot');
    td.onclick = null;
  });

  const courseTT = courseTimetables[course];

  if (!courseTT) {
    alert('âŒ Course timetable not found');
    return;
  }

  let found = false;

  Object.keys(courseTT).forEach(dayName => {
    const daySlots = courseTT[dayName];

    Object.keys(daySlots).forEach(slotStr => {
      const slotIndex = Number(slotStr);
      const entry = daySlots[slotStr];

      if (
        entry.subject &&
        entry.subject.toLowerCase().includes('library')
      ) {
        const row = [...document.querySelectorAll('tbody tr')]
          .find(r => r.querySelector('th')?.innerText.trim() === dayName);

        if (!row) return;

        let currentSlot = 0;

        row.querySelectorAll('td').forEach(td => {
          const colspan = parseInt(td.getAttribute('colspan') || 1);

          if (currentSlot === slotIndex) {
            found = true;
            td.classList.add('available-slot');

            td.onclick = () => {
              active.targetDay = dayName;
              active.targetSlot = slotIndex;
              
              // Show date picker with only same day dates
              generateSmartDatePicker(dayName);
              document.getElementById('dateModal').classList.remove('hidden');
            };
          }

          currentSlot += colspan;
        });
      }
    });
  });

  if (!found) {
    alert('âŒ No Library slots available in this course timetable');
  }
}

// ğŸ—“ï¸ SMART DATE PICKER - Show only same day dates
function generateSmartDatePicker(targetDay) {
  const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const dayIndex = daysOfWeek.indexOf(targetDay);
  
  // Get all dates for this day (today + next few weeks)
  const today = new Date();
  const dates = [];
  
  // Get next 12 weeks of same day
  for (let i = 0; i < 12; i++) {
    const date = new Date(today);
    // Calculate days to add to get to targetDay
    const currentDayIndex = date.getDay();
    let daysToAdd = dayIndex - currentDayIndex;
    
    if (i === 0 && daysToAdd < 0) {
      daysToAdd += 7;
    } else if (i > 0) {
      daysToAdd = (dayIndex - currentDayIndex + 7) % 7;
      if (daysToAdd === 0) daysToAdd = 7;
      daysToAdd += (i - 1) * 7;
    }
    
    date.setDate(date.getDate() + daysToAdd);
    dates.push(new Date(date));
  }
  
  // Generate buttons for each date
  const dateList = document.getElementById('dateList');
  dateList.innerHTML = dates.map((d, idx) => {
    const dateStr = d.toISOString().split('T')[0];
    const displayDate = d.toLocaleDateString('en-GB', { 
      weekday: 'short', 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
    const isToday = d.toDateString() === today.toDateString();
    
    return `<button onclick="selectDate('${dateStr}')" 
      class="w-full text-left p-2 rounded border ${isToday ? 'bg-green-100 border-green-400 font-bold' : 'bg-white hover:bg-blue-50'}">
      ${isToday ? 'ğŸ“… Today - ' : 'ğŸ“… '} ${displayDate}
    </button>`;
  }).join('');
}

function selectDate(dateStr) {
  // Store date and load rooms
  active.selectedDate = dateStr;
  loadRooms(dateStr);
}

function loadRooms(date){
  if (!date) {
    alert('Please select a date');
    return;
  }

  fetch(`/schedule/api/free-rooms?day=${active.targetDay}&slot=${active.targetSlot}&date=${date}`)
    .then(r => r.json())
    .then(d => {
      if (!d.rooms || d.rooms.length === 0) {
        alert('âŒ No rooms available');
        return;
      }

      roomList.innerHTML = d.rooms.map(r => {
        const type = r.classOrLab === 'lab' ? 'ğŸ”¬ Lab' : 'ğŸ“š Class';
        return `<button class="block w-full border p-3 mt-2 hover:bg-blue-50 text-left rounded"
          onclick="finalSchedule('${r.roomNumber}','${r.building}','${date}')" 
          title="Building: ${r.building}">
          <div class="font-semibold">ğŸ›ï¸ ${r.roomNumber}</div>
          <div class="text-sm text-gray-600">Building: ${r.building} | ${type}</div>
        </button>`;
      }).join('');

      document.getElementById('dateModal').classList.add('hidden');
      document.getElementById('roomModal').classList.remove('hidden');
    });
}

function finalSchedule(room, building, date){
  // Check if this is a reschedule operation
  const isReschedule = !!active.rescheduleId;
  const endpoint = isReschedule 
    ? `/schedule/api/reschedule/${active.rescheduleId}`
    : '/schedule/api/save-temporary-schedule';

  console.log('ğŸ“ ' + (isReschedule ? 'Rescheduling' : 'Scheduling') + ' class:', {
    course: active.course,
    from: {day: active.day, slot: active.slot},
    to: {day: active.targetDay, slot: active.targetSlot, date},
    room,
    building
  });

  const payload = isReschedule
    ? {
        to: {day: active.targetDay, slot: active.targetSlot, date},
        room,
        building
      }
    : {
        teacherId: '<%= teacherId %>',
        course: active.course,
        subject: active.subject || '',
        from: {day: active.day, slot: active.slot},
        to: {day: active.targetDay, slot: active.targetSlot, date},
        room,
        building
      };

  fetch(endpoint, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  })
  .then(r => {
    console.log('Response status:', r.status);
    return r.json();
  })
  .then(d => {
    console.log('Response data:', d);
    if(d.success) {
      alert('âœ… ' + (d.message || (isReschedule ? 'Class rescheduled successfully!' : 'Class scheduled successfully!')));
      location.reload();
    } else {
      alert('âŒ Error: ' + (d.error || 'Failed to ' + (isReschedule ? 'reschedule' : 'schedule')));
      console.error('Server error:', d.error);
    }
  })
  .catch(err => {
    console.error('âŒ Fetch error:', err);
    alert('âŒ Network error: ' + err.message);
  });
}
</script>

</body>
</html>
