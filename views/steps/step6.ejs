<%- include('../partials/header') %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Step 6 - Timetable Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<% if (saved) { %>
  <div class="text-green-700 text-center font-semibold mt-4">
    ‚úÖ Timetable saved successfully!
  </div>
<% } %>
<!-- Navigation Steps -->
<nav class="bg-[#EEEEEE] shadow-md py-4">
  <div class="max-w-7xl mx-auto px-6">
    <ul class="flex justify-between text-sm md:text-base text-[#0F044C] font-medium">
      <li class="font-bold px-4">Step 1: <a href="/step1" class="hover:text-[#0F044C]">Setup</a></li>
      <li class="font-bold px-4">Step 2: <a href="/step2" class="hover:text-[#0F044C]">Subjects</a></li>
      <li class="font-bold px-4">Step 3: <a href="/step3" class="hover:text-[#0F044C]">Courses</a></li>
      <li class="font-bold px-4">Step 4: <a href="/step4" class="hover:text-[#0F044C]">Classrooms</a></li>
      <li class="font-bold px-4">Step 5: <a href="/step5" class="hover:text-[#0F044C]">Teachers</a></li>
      <li class="text-[#0F044C] font-bold px-4">Step 6: Generate</li>
      </ul>
  </div>
</nav>

<!-- Page Heading -->
<div class="flex items-center justify-center my-10 relative">
  <a href="/step5">
    <button type="button" class="absolute top-0 left-7 text-1xl bg-[#141E61] text-white px-6 py-2 rounded-md hover:bg-[#787A91] transition duration-300">
      ‚Üê Back
    </button>
  </a>
  <a href="/auth/logout" class="btn btn-outline-danger absolute top-0 right-7 text-1xl bg-[#141E61] text-white px-6 py-2 rounded-md hover:bg-[#787A91] transition duration-300">
    Logout
  </a>
  <div class="text-center">
    <h1 class="text-3xl font-bold text-[#0F044C]">Step 6: Timetable Generator</h1>
    <p class="text-[#141E61] mt-2">Configure your preferences below</p>
  </div>
</div>

<!-- Form Card for Generate Timetable -->
<div class="max-w-6xl mx-auto bg-[#EEEEEE] shadow-lg rounded-lg p-8 mt-10">
  <form action="/step6/generate" method="POST" class="space-y-6">
    <div class="grid grid-cols-3 gap-6">
      <div>
        <label class="block text-[#0F044C] font-medium mb-1">University Name</label>
        <input type="text" name="university" required placeholder="Enter University Name"
               class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#0F044C]">
      </div>
      <div>
        <label class="block text-[#0F044C] font-medium mb-1">Faculty Name</label>
        <input type="text" name="faculty" required placeholder="Enter Faculty Name"
               class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#0F044C]">
      </div>
      <div>
        <label class="block text-[#0F044C] font-medium mb-1">Effective From Date</label>
        <input type="date" name="date" required
               class="w-full border border-gray-300 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-[#0F044C]">
      </div>
    </div>
    <div class="text-right">
      <button type="submit"
              class="bg-[#141E61] text-white px-6 py-2 rounded-md hover:bg-[#787A91] transition duration-300">
        Generate Timetable
      </button>
    </div>
  </form>
</div>
<br><br><br><br>

<% if (timetable && timetable.timetable) { %>
  <% Object.keys(timetable.timetable).forEach(course => { %>
    <div style="page-break-after: always;">
      <table border="1" cellpadding="3" cellspacing="0" style="width:95%; margin: 0 auto 60px auto; font-size: 0.9em; text-align:center;">
        <thead style="color: #ffffff;">
          <tr>
            <th colspan="<%= timetable.slots.length + 1 %>" style="font-size: 1.5em; text-align:center;"><%= university %></th>
          </tr>
          <tr>
            <th colspan="3" style="text-align:center;"><%= course %></th>
            <th colspan="<%= timetable.slots.length - 4 %>" style="text-align:center;"><%= faculty %></th>
            <th colspan="3" style="text-align:center;">w.e.f :  <%= wefDate %></th>
          </tr>
          <tr>
            <th>Day / Slot</th>
            <% timetable.slots.forEach((slot) => { %>
              <th><%= slot === '1:00-1:30' ? 'Break' : slot %></th>
            <% }) %>
          </tr>
        </thead>
        <tbody>
          <% timetable.days.forEach(day => { %>
            <tr>
              <td style="background-color: white;"><strong><%= day %></strong></td>
              <% let skipNext = false; %>
              <% timetable.timetable[course][day].forEach((cell, idx) => { %>
                <% if (skipNext) { skipNext = false; return; } %>
                <% const isLab = cell.subject.includes('Lab-1') || cell.subject.includes('Lab-2'); %>
                <% if (isLab) { %>
                  <td colspan="2" style="background-color:#CBDCEB; text-align: center;">
                    <div><strong><%= cell.room %></strong></div>
                    <div><%= cell.subject.replace(' (Lab-1)', ' (G1)').replace(' (Lab-2)', ' (G2)') %></div>
                    <div><%= cell.teacher %></div>
                  </td>
                  <% skipNext = true; %>
                <% } else if (timetable.slots[idx] === '1:00-1:30') { %>
                  <td>
                    Break
                  </td>
                <% } else { %>
                  <td>
                    <div><strong><%= cell.room %></strong></div>
                    <div><%= cell.subject %></div>
                    <div><%= cell.teacher %></div>
                  </td>
                <% } %>
              <% }) %>
            </tr>
          <% }) %>
        </tbody>
      </table>

      <!-- Subject and Teacher Summary Table -->
      <table border="1" cellpadding="0" cellspacing="3" style="width:60%; ; margin: 0 auto 60px auto; font-size: 0.9em; text-align:center;">
        <thead style="color: #ffffff; ">
          <tr>
            <th colspan="4" style="text-align:center;">Subject and Teacher Mapping for <%= course %></th>
          </tr>
          <tr>
            <th>Subject Short</th>
            <th>Subject Full</th>
            <th>Teacher Short</th>
            <th>Teacher Full</th>
          </tr>
        </thead>
        <tbody>
          <% if (timetable.subjectTeachers && timetable.subjectTeachers[course]) { %>
            <% timetable.subjectTeachers[course].forEach(entry => { %>
              <tr>
                <td><%= entry.subjectShort %></td>
                <td><%= entry.subjectLong %></td>
                <td><%= entry.teacherShort %></td>
                <td><%= entry.teacherLong %></td>
              </tr>
            <% }) %>
          <% } else { %>
            <tr><td colspan="4">No subject-teacher data available for this course.</td></tr>
          <% } %>
        </tbody>
      </table>
    </div>
  <% }) %>

  
  <div style="text-align:center; margin-top:20px;">
  <form action="/step6/save" method="POST">
    <input type="hidden" name="university" value="<%= university %>">
    <input type="hidden" name="faculty" value="<%= faculty %>">
    <input type="hidden" name="date" value="<%= wefDate %>">
    <input type="hidden" name="timetableData" value='<%- JSON.stringify(timetable) %>'>
    <button type="submit"
            class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-800 transition duration-300">
      üíæ Save & Upload
    </button>
  </form>
</div>

<% } %>


<%- include('../partials/footer') %>
