<%- include('../partials/header') %>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Step 4 - Classroom Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<!-- Navigation Steps -->
<nav class="bg-[#EEEEEE] shadow-md py-4">
  <div class="max-w-7xl mx-auto px-6">
    <ul class="flex justify-between text-sm md:text-base text-[#0F044C] font-medium">
      <li class="font-bold px-4">Step 1: <a href="/step1" class="hover:text-[#0F044C]">Setup</a></li>
      <li class="font-bold px-4">Step 2: <a href="/step2" class="hover:text-[#0F044C]">Subjects</a></li>
      <li class="font-bold px-4">Step 3: <a href="/step3" class="hover:text-[#0F044C]">Courses</a></li>
      <li class="font-bold px-4">Step 4: <a href="/step4" class="hover:text-[#0F044C]">Classrooms</a></li>
      <li class="text-[#0F044C] font-bold px-4">Step 5: Teachers</li>
      <li class="px-4"><a href="/step6" class="hover:text-[#0F044C]">Step 6: Generate</a></li>
    </ul>
  </div>
</nav>

<!-- Page Heading -->
<div class="flex items-center justify-center my-10 relative">
  <!-- Back arrow button on the left -->
   <a href="/step4">
  <button type="button" class="absolute top-0 left-7 text-1xl bg-[#141E61] text-white px-6 py-2 rounded-md hover:bg-[#787A91] transition duration-300">
    ← Back
  </button>
  </a>
<div class="text-center">
  <h1 class="text-3xl font-bold text-[#0F044C]">Step 5: Teacher Details</h1>
  <p class="text-[#141E61] mt-2">Configure your teacher preferences below</p>
</div>
</div>

<!-- Stylish Add Teacher Form Card -->
<div class="max-w-3xl mx-auto bg-[#EEEEEE] shadow-lg rounded-lg p-8 mb-10">
  <form action="/step5/add" method="POST" class="space-y-6">
    
    <!-- Teacher Name Fields -->
    <div class="grid grid-cols-2 gap-6">
      <div>
        <label class="block text-[#0F044C] font-medium mb-1">Full Name</label>
        <input type="text" name="name" required placeholder="e.g. Dr. Ramesh Sharma"
               class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2" />
      </div>
      <div>
        <label class="block text-[#0F044C] font-medium mb-1">Short Name</label>
        <input type="text" name="shortName" required placeholder="e.g. RS"
               class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2" />
      </div>
    </div>

    <!-- Working Hours and Email -->
    <div class="grid grid-cols-2 gap-6">
      <div>
        <label class="block text-[#0F044C] font-medium mb-1">Working Hours per Week</label>
        <input type="number" name="workingHoursPerWeek" required placeholder="e.g. 12"
               class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2" />
      </div>
      <div>
        <label class="block text-[#0F044C] font-medium mb-1">Email (Optional)</label>
        <input type="email" name="email" placeholder="teacher@svsu.ac.in"
               class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2" />
      </div>
    </div>

    <!-- Time Off Feature -->
    <div>
      <h3 class="text-lg font-semibold text-[#0F044C] mb-2">Teacher Time Off</h3>
      <div id="timeOffSection" class="space-y-4">
        <div class="grid grid-cols-3 gap-4">
          <div>
            <label class="block text-[#0F044C] font-medium mb-1">Day</label>
            <select name="timeOffDay[]" required
                    class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2">
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
            </select>
          </div>

          <div>
            <label class="block text-[#0F044C] font-medium mb-1">Start Time</label>
            <input type="time" name="timeOffStart[]" required
                   class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2" />
          </div>

          <div>
            <label class="block text-[#0F044C] font-medium mb-1">End Time</label>
            <input type="time" name="timeOffEnd[]" required
                   class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2" />
          </div>
        </div>
      </div>

      <button type="button" onclick="addTimeOff()" 
              class="mt-3 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-800 transition duration-300">
        + Add More Time Off
      </button>
    </div>

    <!-- Submit -->
    <div class="text-right">
      <button type="submit"
              class="bg-[#141E61] text-white px-6 py-2 rounded-md hover:bg-[#787A91] transition duration-300">
        Add Teacher
      </button>
    </div>
    </form>
    <form action="/step5/next" method="POST" class="mt-6 text-right">
      <button id="toggleButton" type="button" class="btn btn-primary bg-[#141E61] text-white px-6 py-2 rounded-md hover:bg-[#787A91] transition duration-300" onclick="scrollToTeacherList()">
        View Teacher List
      </button>

    <button type="submit"
            class="bg-[#141E61] text-white px-6 py-2 rounded-md hover:bg-[#787A91] transition duration-300">
      Save & Continue ➡
    </button>
  </form>
</div>

<script>
  function addTimeOff() {
    const section = document.getElementById("timeOffSection");
    const wrapper = document.createElement("div");
    wrapper.className = "space-y-4";

    const div = document.createElement("div");
    div.className = "grid grid-cols-3 gap-4";
    div.innerHTML = `
      <div>
            <label class="block text-[#0F044C] font-medium mb-1">Day</label>
            <select name="timeOffDay[]" required
                    class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2">
              <option value="Monday">Monday</option>
              <option value="Tuesday">Tuesday</option>
              <option value="Wednesday">Wednesday</option>
              <option value="Thursday">Thursday</option>
              <option value="Friday">Friday</option>
            </select>
          </div>

          <div>
            <label class="block text-[#0F044C] font-medium mb-1">Start Time</label>
            <input type="time" name="timeOffStart[]" required
                   class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2" />
          </div>

          <div>
            <label class="block text-[#0F044C] font-medium mb-1">End Time</label>
            <input type="time" name="timeOffEnd[]" required
                   class="w-full border border-gray-400 rounded-md px-4 py-2 focus:ring-[#0F044C] focus:ring-2" />
          </div>
        </div>
      </div>
    `;

    wrapper.appendChild(div);
    section.appendChild(wrapper);
  }
</script>

<% if (teachers.length > 0) { %>
<div id="teacherList" style="display:none;">
<table class="table" style="width: 100%; max-width: 900px; border-collapse: collapse; margin: 30px auto; font-family: Arial, sans-serif; font-size: 16px;" border="1">
    <thead style="background-color: #141E61; color: white;">
      <tr>
        <th style="padding: 6px 8px; text-align: left; white-space: nowrap;">List of Teachers </th>
      </tr>
    </thead>
    <tbody>
      <% teachers.forEach(teacher => { %>
        <tr>
          <td style="padding: 6px 8px;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <span><%= teacher.name %> (<%= teacher.shortName %>)</span>
                <% if (teacher.email) { %>
                  <span style="display: inline-block; margin-left: 10px; background-color: #10b981; color: white; padding: 2px 8px; border-radius: 3px; font-size: 12px;">✓ <%= teacher.email %></span>
                <% } %>
              </div>
              <button onclick="toggleDetails('<%= teacher._id %>')" 
                style="padding: 4px 10px; background-color: #787A91; color: white; border: none; cursor: pointer; border-radius: 3px; font-size: 15px;">
                View
              </button>
            </div>
          </td>
        </tr>

        <!-- Hidden details row -->
<tr id="teacher-details-<%= teacher._id %>" style="display: none; background-color: #f9f9f9;">
  <td colspan="2" style="padding: 10px; display: flex; flex-direction: column; gap: 10px;">

    <p><strong>Working Hours:</strong> <%= teacher.workingHoursPerWeek %> hrs/week</p>
    <% if (teacher.email) { %>
      <p><strong>Email:</strong> <span style="background-color: #10b981; color: white; padding: 2px 6px; border-radius: 3px;"><%= teacher.email %></span></p>
    <% } %>

    <!-- Edit Teacher Info -->
    <form action="/step5/edit/<%= teacher._id %>" method="POST" style="margin-bottom: 10px; font-size: 15px;">
      <input type="text" name="name" value="<%= teacher.name %>" required style="padding: 4px; margin-right: 5px; width: 30%;" />
      <input type="text" name="shortName" value="<%= teacher.shortName %>" required style="padding: 4px; margin-right: 5px; width: 15%;" />
      <input type="number" name="workingHoursPerWeek" value="<%= teacher.workingHoursPerWeek %>" required style="padding: 4px; width: 15%;" />
      <input type="email" name="email" value="<%= teacher.email || '' %>" placeholder="teacher@svsu.ac.in" style="padding: 4px; margin-right: 5px; width: 25%;" />

      <h4 name="timeOffDay[]" style="margin-top: 10px; margin-bottom: 6px; font-size: 16px;"><strong>Teacher Time Off:</strong></h4>
      <div>
        <% teacher.timeOff.forEach((time, idx) => { %>
          <div style="margin-bottom: 4px;">
            <select name="timeOffDay" style="padding: 3px; font-size: 15px;">
              <option value="Monday" <%= time.day === 'Monday' ? 'selected' : '' %>>Mon</option>
              <option value="Tuesday" <%= time.day === 'Tuesday' ? 'selected' : '' %>>Tue</option>
              <option value="Wednesday" <%= time.day === 'Wednesday' ? 'selected' : '' %>>Wed</option>
              <option value="Thursday" <%= time.day === 'Thursday' ? 'selected' : '' %>>Thu</option>
              <option value="Friday" <%= time.day === 'Friday' ? 'selected' : '' %>>Fri</option>
            </select>
            <input type="time" name="timeOffStart[]" value="<%= time.start %>" required style="padding: 3px; font-size: 15px; width: 90px; margin-left: 5px;" />
            <input type="time" name="timeOffEnd[]" value="<%= time.end %>" required style="padding: 3px; font-size: 15px; width: 90px; margin-left: 5px;" />
          </div>
        <% }) %>
      </div>

      <button type="submit" style="margin-top: 6px; padding: 5px 12px; font-size: 15px;" class="mt-2 bg-blue-600 text-white px-4 py-1 rounded">
        Update
      </button>
    </form>

    <!-- Assign Course/Subject (Bulk) -->
    <h4 style="margin-top: 10px; margin-bottom: 6px; font-size: 16px;"><strong>Assigning Course/Subjects:</strong></h4>

    <!-- NOTE: per-teacher IDs below -->
    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center; font-size: 15px;">
      <label>Course:</label>
      <select id="courseSelect-<%= teacher._id %>" style="padding: 4px; font-size: 15px;">
        <option value="">Select Course</option>
        <% courses.forEach(course => { %>
          <option value="<%= course._id %>"><%= course.courseName %></option>
        <% }) %>
      </select>

      <label>Subject:</label>
      <select id="subjectSelect-<%= teacher._id %>" style="padding: 4px; font-size: 15px;">
        <option value="">Select Subject</option>
      </select>

      <button type="button" id="addToListBtn-<%= teacher._id %>" style="padding: 4px 10px; font-size: 15px;" class="bg-green-700 text-white rounded">
        Add to List
      </button>
    </div>

    <!-- Assigned Subjects -->
    <h4 style="font-size: 16px; margin-bottom: 5px; margin-top: 10px;"><strong>Assigned Course/Subjects:</strong></h4>
    <table border="1" style="border-collapse: collapse; width: 100%;">
      <thead>
        <tr style="background-color: #141E61; color: white;">
          <th style="font-weight: normal;">Course</th>
          <th style="font-weight: normal;">Subject</th>
          <th style="font-weight: normal;">Actions</th>
        </tr>
      </thead>
      <tbody id="assignedTable-<%= teacher._id %>">
        <% teacher.assignments.forEach(a => { %>
          <tr>
            <td><%= a.course ? a.course.courseName : 'N/A' %></td>
            <td><%= a.subject ? (a.subject.fullName + ' (' + a.subject.shortName + ')') : 'N/A' %></td>
            <td>
              <button type="button" class="deleteAssignmentBtn" data-id="<%= a._id %>" data-teacher="<%= teacher._id %>">Remove</button>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <!-- Delete Teacher -->
    <form action="/step5/delete/<%= teacher._id %>" method="POST" onsubmit="return confirm('Are you sure you want to delete this teacher?')" style="margin-top: 10px; text-align: right;">
      <button type="submit" style="background-color: rgb(235, 133, 133); color: white; padding: 5px 12px; border: none; cursor: pointer; border-radius: 3px; font-size: 15px;">
        Delete Teacher
      </button>
    </form>
  </td>
</tr>


      <% }) %>
    </tbody>
  </table>
</div>
<% } else { %>
  <p>No teachers added yet.</p>
<% } %>

<script>
  function toggleDetails(id) {
    const row = document.getElementById('teacher-details-' + id);
    if (row.style.display === 'none' || row.style.display === '') {
      document.querySelectorAll('[id^="teacher-details-"]').forEach(r => r.style.display = 'none');
      row.style.display = 'table-row';
    } else {
      row.style.display = 'none';
    }
  }
</script>


<script src="/js/step5.js"></script>

<%- include('../partials/footer') %>

<script>
  function scrollToTeacherList() {
    const table = document.getElementById('teacherList');
    const btn = document.getElementById('toggleButton');
    
    if (table.style.display === 'none' || table.style.display === '') {
      table.style.display = 'block';
      btn.textContent = 'Hide Teacher List';
      table.scrollIntoView({ behavior: 'smooth' });
    } else {
      table.style.display = 'none';
      btn.textContent = 'View Teacher List';
    }
  }
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll("[id^=courseSelect-]").forEach(courseDropdown => {
    const teacherId = courseDropdown.id.split("-")[1];
    const subjectDropdown = document.getElementById(`subjectSelect-${teacherId}`);
    const addToListBtn = document.getElementById(`addToListBtn-${teacherId}`);
    const assignedTable = document.getElementById(`assignedTable-${teacherId}`);

    // Subjects load on course change
    courseDropdown.addEventListener("change", async function () {
      subjectDropdown.innerHTML = `<option>Loading...</option>`;
      const res = await fetch(`/step5/getSubjectsByCourse/${this.value}`);
      const subjects = await res.json();
      subjectDropdown.innerHTML = `<option value="">Select Subject</option>`;
      subjects.forEach(s => {
        subjectDropdown.innerHTML += `<option value="${s._id}">${s.fullName} (${s.shortName})</option>`;
      });
    });

    // Direct assign on button click
    addToListBtn.addEventListener("click", async function () {
      const courseId = courseDropdown.value;
      const subjectId = subjectDropdown.value;
      if (!courseId || !subjectId) return alert("Select course and subject");

      // POST request to assign
      const res = await fetch(`/step5/assign/${teacherId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ course: courseId, subject: subjectId })
      });

      const data = await res.json();
      if (data.success) {
        // Refresh assigned list from backend
        const listRes = await fetch(`/step5/getAssignments/${teacherId}`);
        const assignments = await listRes.json();
        renderAssignedTable(assignments);
        courseDropdown.value = "";
        subjectDropdown.innerHTML = `<option value="">Select Subject</option>`;
      } else {
        alert(data.error || "Error assigning subject");
      }
    });

    function renderAssignedTable(assignments) {
      assignedTable.innerHTML = assignments.map(a => `
        <tr>
          <td>${a.course.courseName}</td>
          <td>${a.subject.fullName} (${a.subject.shortName})</td>
          <td>
            <button type="button" class="deleteAssignmentBtn" data-id="${a._id}">Remove</button>
          </td>
        </tr>
      `).join("");
    }

    // Handle delete & edit
    assignedTable.addEventListener("click", function (e) {
      if (e.target.classList.contains("deleteAssignmentBtn")) {
        const assignmentId = e.target.dataset.id;
        fetch(`/step5/assign/${teacherId}/${assignmentId}`, { method: "DELETE" })
          .then(res => res.json())
          .then(updatedAssignments => renderAssignedTable(updatedAssignments));
      }
    });
  });
});


</script>